image: Visual Studio 2017  # образ для сборки

environment:
  nodejs_version: "6"
  MYSQL_DATABASE: node_mysql
  MYSQL_HOST: localhost
  MYSQL_USER: root
  MYSQL_PASSWORD: Password12!
  MYSQL_PATH: C:\Program Files\MySQL\MySQL Server 5.7
  MYSQL_PORT: 3306
  DOCKER_USERNAME: murrk
  DOCKER_PASSWORD:
    secure: l6Nlva10IqJeiLSCqbulog==
  DOCKER_REGISTRY: docker.io/murrk/

services:
  - mysql

branches:
  only:
    - master  

build: off 

install:
  - ps: sudo curl -L "https://github.com/docker/compose/releases/download/1.26.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - ps: sudo chmod +x /usr/local/bin/docker-compose
  - ps: sudo docker-compose up -d
  - sleep 10
  - java -Dspring.datasource.url=jdbc:mysql://localhost:3306/app -jar aqa-shop.jar &
  - ps: npm install -g npm@latest
  - ps: $App = Start-Process -FilePath java -ArgumentList "-jar ./app-shop.jar -P:jdbc.url=jdbc:mysql://192.168.99.100:3306/app -P:jdbc.user=app -P:jdbc.password=pass" -PassThru


 test_script:
   - sudo chmod +x gradlew
   - ps: ./gradlew test --info “-Dselenide.headless=true”
 
 build_script:
   - sleep 10
   - sudo chmod +x ./gradlew
   - ./gradlew test -Dselenide.headless=true -Durlbd=jdbc:mysql://localhost:3306/app
  
deploy_script:
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  - docker-compose docker-compose-mysql.yml up -d push
  
on_finish:
  - ps: Stop-Process -Id $App.Id  
